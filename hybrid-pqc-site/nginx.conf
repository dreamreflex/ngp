worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # ========== PQC 相关 map ==========

    # 把 ssl_curve 的原始值映射为对应的名字
    map $ssl_curve $pqc_group {
        "0x11ec"   "X25519MLKEM768";
        "0x6399"   "X25519Kyber768Draft00";
        default    $ssl_curve;
    }

    # 根据组名称判断是否为 PQC / 混合 PQC
    map $pqc_group $pqc_status {
        "~MLKEM"            "hybrid_pqc";
        "~Kyber768Draft00"  "hybrid_pqc_draft";
        default             "no_pqc";
    }

    # 标记是否 TLS1.3
    map $ssl_protocol $tls13 {
        "TLSv1.3"   "1";
        default     "0";
    }

    # 自定义日志格式（方便以后排查 PQC）
    log_format pqc_log '$remote_addr "$request" '
                       'prot=$ssl_protocol cipher=$ssl_cipher '
                       'curve=$ssl_curve curves_cli=$ssl_curves '
                       'pqc_status=$pqc_status';

    access_log  logs/access_pqc.log pqc_log;

    # =======================
    # 80 端口 HTTP 跳 HTTPS
    # =======================
    server {
        listen      80;
        server_name pqc.dreamreflex.com;
        return 301 https://$host$request_uri;
    }

    # =======================
    # 443 端口 HTTPS 主站
    # =======================
    server {
        listen 443 ssl;
        http2 on;
        server_name pqc.dreamreflex.com;

        ssl_certificate     /opt/qsc/nginx/conf/tls/pqc.dreamreflex.com.fullchain.pem;
        ssl_certificate_key /opt/qsc/nginx/conf/tls/pqc.dreamreflex.com.key;

        # 只启用 TLS 1.3
        ssl_protocols       TLSv1.3;
        ssl_prefer_server_ciphers on;

        # ========== TLS 安全相关响应头 ==========

        # HSTS and CSP
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header Content-Security-Policy "upgrade-insecure-requests" always;

        # 暴露 TLS/PQC Header 信息
        add_header X-TLS-Protocol   $ssl_protocol  always;
        add_header X-TLS-Cipher     $ssl_cipher    always;
        add_header X-TLS-Curve      $pqc_group     always;
        add_header X-PQC-Status     $pqc_status    always;
        add_header X-TLS-TLS13      $tls13         always;


        root   html;


        location / {
            index  index.html;
        }

        location /api/ {
           
            proxy_pass http://127.0.0.1:8000/;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # ===== TLS 协商结果 =====
            proxy_set_header X-TLS-Protocol      $ssl_protocol;
            proxy_set_header X-TLS-Cipher        $ssl_cipher;
            proxy_set_header X-TLS-Curve-Raw     $ssl_curve;    # 原始值，例如 0x11ec
            proxy_set_header X-TLS-Curve         $pqc_group;    # 映射后的名字
            proxy_set_header X-PQC-Status        $pqc_status;   # no_pqc / hybrid_pqc / ...

            # ===== 客户端能力（支持的 cipher / 曲线列表）=====
            proxy_set_header X-TLS-Cipher-List   $ssl_ciphers;
            proxy_set_header X-TLS-Curves-Client $ssl_curves;

            # ===== ALPN / 早期数据 等附加信息 =====
            proxy_set_header X-TLS-ALPN          $ssl_alpn_protocol;
            proxy_set_header X-TLS-Early-Data    $ssl_early_data;

            # ===== 服务器侧启用的组（写死的，方便后端展示）=====
            proxy_set_header X-TLS-Server-Groups "X25519MLKEM768:X25519:prime256v1";
        }
    }
}