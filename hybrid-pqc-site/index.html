<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>PQC 兼容性测试</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #f4f4f4;
      --panel: #ffffff;
      --panel-border: #d5d5d5;
      --ink: #111111;
      --muted: #4a4a4a;
      --accent: #111111;
      --accent-soft: #e6e6e6;
      --danger: #1f1f1f;
      --danger-soft: #ededed;
      --code-bg: #1a1a1a;
      font-family: "Segoe UI", "PingFang SC", "Microsoft Yahei", system-ui, sans-serif;
      color: var(--ink);
      background-color: var(--bg);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--ink);
      display: flex;
      justify-content: center;
      position: relative;
      overflow-x: hidden;
    }

    .page {
      width: 100%;
      max-width: 1100px;
      padding: 6px 16px 64px;
      position: relative;
      z-index: 1;
    }

    header {
      margin-bottom: 6px;
    }

    .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 16px;
      background: #ffffff;
      border: 1px solid var(--panel-border);
      color: var(--ink);
      font-size: 0.82rem;
    }

    h1 {
      margin: 12px 0 8px;
      font-size: clamp(1.8rem, 3vw, 2.4rem);
      letter-spacing: -0.01em;
    }

    .subtitle {
      margin: 0;
      max-width: 760px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 0.98rem;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.3fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      padding: 20px 20px 18px;
      box-shadow: none;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
    }

    .status-meta {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .status-title {
      margin: 4px 0 6px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .status-desc {
      margin: 0;
      font-size: 0.92rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
      letter-spacing: 0.01em;
      border: 1px solid var(--panel-border);
      transition: color 0.15s ease, background-color 0.15s ease, border-color 0.15s ease;
    }

    .status-badge.no {
      background: var(--danger-soft);
      color: var(--danger);
      border-color: var(--panel-border);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0 4px;
    }

    .badge-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid var(--panel-border);
      background: #fafafa;
      color: var(--ink);
      font-size: 0.82rem;
    }

    .badge-chip.positive {
      border-color: var(--ink);
      color: var(--ink);
      background: #ededed;
    }

    .badge-chip.negative {
      border-color: #b0b0b0;
      color: #303030;
      background: #f2f2f2;
    }

    .key-values {
      margin-top: 8px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: #fafafa;
      padding: 10px 12px;
    }

    .kv-row {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px dashed var(--panel-border);
      align-items: center;
      font-size: 0.92rem;
    }

    .kv-row:last-child { border-bottom: none; }
    .kv-key { color: var(--muted); }
    .kv-value {
      text-align: right;
      font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;
      color: var(--ink);
      word-break: break-all;
    }

    .section-title {
      margin: 0 0 8px 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .list {
      margin: 0;
      padding-left: 1.1rem;
      color: var(--muted);
      line-height: 1.6;
      font-size: 0.95rem;
    }

    .callout {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: #f7f7f7;
      color: var(--ink);
      font-size: 0.9rem;
    }

    .muted-label {
      color: var(--muted);
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .code-block {
      margin-top: 8px;
      border-radius: 10px;
      background: var(--code-bg);
      color: #f1f1f1;
      padding: 10px 12px;
      font-size: 0.82rem;
      font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;
      max-height: 180px;
      overflow: auto;
      box-shadow: none;
    }

    .small {
      font-size: 0.82rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .error-text {
      color: var(--danger);
      font-size: 0.88rem;
      margin-top: 10px;
      display: none;
    }

    footer {
      margin-top: 28px;
      padding: 18px 12px 8px;
      border-top: 1px solid var(--panel-border);
      color: var(--muted);
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .footer-title {
      color: var(--ink);
      font-weight: 600;
    }

    @media (max-width: 700px) {
      footer {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <strong>PQC 兼容性测试</strong>
    </header>
    <main>
      <section class="card" id="status-card">
        <div class="status-row">
          <div>
            <p class="status-meta">当前握手</p>
            <p class="status-title" id="status-title">正在检测 PQC 状态…</p>
            <p class="status-desc" id="status-desc">正在请求 /api/pqc-full，并解码 TLS / PQC 信息。</p>
          </div>
          <div class="status-badge" id="status-badge">
            <span class="status-dot"></span>
            <span id="status-badge-text">检测中</span>
          </div>
        </div>

        <div class="status-chip-row" id="status-chip-row"></div>

        <div class="key-values" id="kv-container"></div>

        <p class="small" style="margin-top: 10px;">
          说明：结果仅代表<strong>本次</strong> TLS 握手的真实协商，不会修改浏览器或系统设置。
        </p>
        <div class="error-text" id="error-text"></div>
      </section>

      <section class="card">
        <p class="section-title">PQC进程</p>
        <ul class="list">
          <li>启用启用混合后量子密钥协商对于量子计算机面临的挑战是非常必要的，我们正在将内部网络和双向安全通讯都升级为PQC体系。</li>     
          <li>如果您希望了解更多可以参考<a href="https://doc.dreamreflex.com/%E5%AE%89%E5%85%A8%E7%BD%91%E7%BB%9C/PQC">后量子加密（PQC）白皮书</a></li>
          <li>我们的边缘节点会接受您的请求，这其中就会包含浏览器的握手信息和协商信息</li>
          <li>浏览器通过 HTTPS 建立 TLS 1.3 连接，Nginx 将协商结果写入响应头（协议 / 密码套件 / 曲线）。</li>
          <li>经过分析后您便可看到您所使用的浏览器是否支持</li>
        </ul>

        <div class="callout">
          <div class="muted-label">来自 Nginx 的响应头</div>
          <div class="small">X-TLS-Protocol · X-TLS-Cipher · X-TLS-Curve · X-PQC-Status · X-TLS-TLS13</div>
        </div>

        <div style="margin-top: 16px;">
          <div class="muted-label">调试 JSON</div>
          <div class="code-block" id="debug-json">等待 API 返回...</div>
        </div>
      </section>
    </main>

    <footer>
      <div>
        <div class="footer-title">DreamReflex Research PQC-Team</div>
        <div>后量子密码兼容性观测页，呈现一次握手的真实协商结果。</div>
      </div>
      <div>
        如需支持请联系<a href="mailto://phil616@163.com">安全团队</a>· 本页仅供验证参考
      </div>
    </footer>
  </div>

  <script>
    function setStatusLoading() {
      const badge = document.getElementById("status-badge");
      const badgeText = document.getElementById("status-badge-text");
      const title = document.getElementById("status-title");
      const desc = document.getElementById("status-desc");
      const chips = document.getElementById("status-chip-row");
      const kv = document.getElementById("kv-container");
      const debug = document.getElementById("debug-json");
      const err = document.getElementById("error-text");

      badge.classList.remove("ok", "no");
      badgeText.textContent = "检测中";
      title.textContent = "正在检测 PQC 状态…";
      desc.textContent = "正在请求 /api/pqc-full，并解码 TLS / PQC 信息。";
      chips.innerHTML = "";
      kv.innerHTML = "";
      debug.textContent = "等待 API 返回...";
      err.style.display = "none";
      err.textContent = "";
    }

    function setStatus(info) {
      const badge = document.getElementById("status-badge");
      const badgeText = document.getElementById("status-badge-text");
      const title = document.getElementById("status-title");
      const desc = document.getElementById("status-desc");
      const chips = document.getElementById("status-chip-row");
      const kv = document.getElementById("kv-container");
      const debug = document.getElementById("debug-json");

      const pqcEnabled = !!info.pqc_enabled;
      const pqcStatus = info.pqc_status || "unknown";
      const tlsProtocol = info.tls_protocol || "未知";
      const cipher = info.tls_cipher || "未知";
      const curve = info.tls_curve || info.tls_curve_raw || "未知";

      badge.classList.remove("ok", "no");
      if (pqcEnabled) {
        badge.classList.add("ok");
        badgeText.textContent = "已启用 PQC / 混合密钥";
        title.textContent = "本次连接协商了后量子密码（或混合密钥交换）。";
        desc.textContent = "密钥交换组包含 ML-KEM / Kyber 系列算法，流量已升级至 PQC 轨道。";
      } else {
        badge.classList.add("no");
        badgeText.textContent = "未使用 PQC";
        title.textContent = "当前连接尚未协商到后量子密钥。";
        desc.textContent = "可能是浏览器/系统/中间设备暂不支持，或优先组未命中 PQC。";
      }

      chips.innerHTML = "";

      const tlsChip = document.createElement("div");
      tlsChip.className = "badge-chip";
      tlsChip.textContent = "TLS " + tlsProtocol;
      chips.appendChild(tlsChip);

      const curveChip = document.createElement("div");
      curveChip.className = "badge-chip";
      curveChip.textContent = "组 " + curve;
      chips.appendChild(curveChip);

      const statusChip = document.createElement("div");
      statusChip.className = "badge-chip " + (pqcEnabled ? "positive" : "negative");
      statusChip.textContent = "PQC: " + (pqcEnabled ? pqcStatus : "disabled / not used");
      chips.appendChild(statusChip);

      const rows = [
        ["TLS 协议", tlsProtocol],
        ["密码套件", cipher],
        ["密钥交换组", curve],
        ["PQC 状态", pqcStatus],
        ["是否 TLS 1.3", info.tls13 ? "是" : "否"],
        ["启用 PQC", pqcEnabled ? "是" : "否"],
        ["客户端支持曲线", info.client_curves || "未知"],
        ["服务器优先组", info.server_groups || "未返回"],
      ];

      kv.innerHTML = "";
      rows.forEach(([k, v]) => {
        const row = document.createElement("div");
        row.className = "kv-row";
        const kk = document.createElement("div");
        kk.className = "kv-key";
        kk.textContent = k;
        const vv = document.createElement("div");
        vv.className = "kv-value";
        vv.textContent = v;
        row.appendChild(kk);
        row.appendChild(vv);
        kv.appendChild(row);
      });

      if (info.details && typeof info.details === "object") {
        Object.entries(info.details).forEach(([k, v]) => {
          const row = document.createElement("div");
          row.className = "kv-row";
          const kk = document.createElement("div");
          kk.className = "kv-key";
          kk.textContent = k;
          const vv = document.createElement("div");
          vv.className = "kv-value";
          vv.textContent = String(v);
          row.appendChild(kk);
          row.appendChild(vv);
          kv.appendChild(row);
        });
      }

      debug.textContent = JSON.stringify(info, null, 2);
    }

    function setError(err) {
      const badge = document.getElementById("status-badge");
      const badgeText = document.getElementById("status-badge-text");
      const title = document.getElementById("status-title");
      const desc = document.getElementById("status-desc");
      const debug = document.getElementById("debug-json");
      const errBox = document.getElementById("error-text");

      badge.classList.remove("ok");
      badge.classList.add("no");
      badgeText.textContent = "检测失败";
      title.textContent = "无法获取 PQC 状态";
      desc.textContent = "访问 /api/pqc-full 时出现错误，请稍后再试或检查服务器日志。";
      debug.textContent = String(err);
      errBox.style.display = "block";
      errBox.textContent = "错误详情: " + String(err);
    }

    (function init() {
      setStatusLoading();
      fetch("/api/pqc-full", { credentials: "same-origin" })
        .then(function (r) {
          if (!r.ok) {
            throw new Error("HTTP " + r.status + " " + r.statusText);
          }
          return r.json();
        })
        .then(function (info) {
          setStatus(info);
        })
        .catch(function (e) {
          setError(e);
        });
    })();
  </script>
</body>
</html>
